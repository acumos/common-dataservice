-- ===============LICENSE_START=======================================================
-- Acumos Apache-2.0
-- ===================================================================================
-- Copyright (C) 2018 AT&T Intellectual Property & Tech Mahindra. All rights reserved.
-- ===================================================================================
-- This Acumos software file is distributed by AT&T and Tech Mahindra
-- under the Apache License, Version 2.0 (the "License");
-- you may not use this file except in compliance with the License.
-- You may obtain a copy of the License at
--
--      http://www.apache.org/licenses/LICENSE-2.0
--
-- This file is distributed on an "AS IS" BASIS,
-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-- See the License for the specific language governing permissions and
-- limitations under the License.
-- ===============LICENSE_END=========================================================

-- Script to upgrade database used by the Common Data Service
-- FROM version 1.18.x TO version 2.0.x.
-- No database name is set to allow flexible deployment.

DROP TABLE C_SOLUTION_VALIDATION;
DROP TABLE C_SOL_VAL_SEQ;
ALTER TABLE C_PEER DROP COLUMN VALIDATION_STATUS_CD;
ALTER TABLE C_SOLUTION_REV DROP COLUMN DESCRIPTION;
ALTER TABLE C_SOLUTION_REV DROP COLUMN VALIDATION_STATUS_CD;
ALTER TABLE C_SOLUTION DROP COLUMN DESCRIPTION;
ALTER TABLE C_SOLUTION ADD COLUMN VIEW_COUNT INT;
ALTER TABLE C_SOLUTION ADD COLUMN DOWNLOAD_COUNT INT;
ALTER TABLE C_SOLUTION ADD COLUMN LAST_DOWNLOAD TIMESTAMP NULL DEFAULT 0;
ALTER TABLE C_SOLUTION ADD COLUMN RATING_AVG_TENTHS INT;
ALTER TABLE C_SOLUTION ADD COLUMN RATING_COUNT INT;
ALTER TABLE C_SOLUTION ADD COLUMN FEATURED_YN CHAR(1);
UPDATE C_SOLUTION AS s
  INNER JOIN C_SOLUTION_WEB AS w 
  ON s.SOLUTION_ID = w.SOLUTION_ID
  SET s.VIEW_COUNT        = CASE WHEN w.VIEW_COUNT        IS NULL THEN 0 ELSE w.VIEW_COUNT        END,
      s.DOWNLOAD_COUNT    = CASE WHEN w.DOWNLOAD_COUNT    IS NULL THEN 0 ELSE w.DOWNLOAD_COUNT    END,
      s.LAST_DOWNLOAD     = CASE WHEN w.LAST_DOWNLOAD     IS NULL THEN 0 ELSE w.LAST_DOWNLOAD     END,
      s.RATING_AVG_TENTHS = CASE WHEN w.RATING_AVG_TENTHS IS NULL THEN 0 ELSE w.RATING_AVG_TENTHS END,
      s.RATING_COUNT      = CASE WHEN w.RATING_COUNT      IS NULL THEN 0 ELSE w.RATING_COUNT      END,
      s.FEATURED_YN = w.FEATURED_YN;
DROP TABLE C_SOLUTION_WEB;
ALTER TABLE C_USER MODIFY COLUMN LOGIN_PASS_EXPIRE_DATE TIMESTAMP NULL DEFAULT NULL;
ALTER TABLE C_USER MODIFY COLUMN LAST_LOGIN_DATE TIMESTAMP NULL DEFAULT NULL;
ALTER TABLE C_USER MODIFY COLUMN LOGIN_FAIL_DATE TIMESTAMP NULL DEFAULT NULL;
ALTER TABLE C_USER MODIFY COLUMN VERIFY_EXPIRE_DATE TIMESTAMP NULL DEFAULT NULL;
ALTER TABLE C_NOTIFICATION MODIFY COLUMN START_DATE TIMESTAMP NOT NULL DEFAULT 0;
ALTER TABLE C_NOTIFICATION MODIFY COLUMN END_DATE TIMESTAMP NOT NULL DEFAULT 0;
ALTER TABLE C_NOTIF_USER_MAP MODIFY COLUMN VIEWED_DATE TIMESTAMP NULL DEFAULT NULL;
ALTER TABLE C_SOLUTION_REV ADD COLUMN SV_LICENSE_CD CHAR(2);
ALTER TABLE C_SOLUTION_REV ADD COLUMN SV_VULNER_CD CHAR(2);
CREATE TABLE C_SITE_CONTENT (
  CONTENT_KEY VARCHAR(50) NOT NULL PRIMARY KEY,
  CONTENT_VAL LONGBLOB NOT NULL,
  MIME_TYPE VARCHAR(50) NOT NULL,
  CREATED_DATE TIMESTAMP NOT NULL DEFAULT 0,
  MODIFIED_DATE TIMESTAMP NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
CREATE TABLE C_CATALOG (
  CATALOG_ID CHAR(36) NOT NULL PRIMARY KEY,
  ACCESS_TYPE_CD CHAR(2) NOT NULL,
  NAME VARCHAR(50) NOT NULL,
  PUBLISHER VARCHAR(64),
  DESCRIPTION VARCHAR(1024),
  URL VARCHAR(512) NOT NULL,
  ORIGIN VARCHAR(512),
  CREATED_DATE TIMESTAMP NOT NULL DEFAULT 0,
  MODIFIED_DATE TIMESTAMP NOT NULL,
  UNIQUE INDEX C_CATALOG_C_NAME (NAME)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
CREATE TABLE C_CAT_SOL_MAP (
  CATALOG_ID CHAR(36) NOT NULL,
  SOLUTION_ID CHAR(36) NOT NULL,
  CREATED_DATE TIMESTAMP NOT NULL DEFAULT 0,
  PRIMARY KEY (CATALOG_ID, SOLUTION_ID),
  CONSTRAINT C_CAT_SOL_MAP_C_CATALOG FOREIGN KEY (CATALOG_ID) REFERENCES C_CATALOG (CATALOG_ID),
  CONSTRAINT C_CAT_SOL_MAP_C_SOLUTION FOREIGN KEY (SOLUTION_ID) REFERENCES C_SOLUTION (SOLUTION_ID)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
